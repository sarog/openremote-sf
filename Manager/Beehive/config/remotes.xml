<?xml version="1.0" encoding="UTF-8"?>

<config charset="UTF-8">
   <var-def name="remotes">
      http://lirc.sourceforge.net/remotes/
   </var-def>
   <var-def name="subnodes">
   	<xpath expression="//table//tr[position()>3]">
      <html-to-xml>  
         <http url="${remotes}"/>  
      </html-to-xml>
      </xpath>
   </var-def>
   
   <loop item = "curnode" maxloops = "${subnodes.toList().size()-1}">
         <list><var name = "subnodes"/></list>
         <body>
            <var-def name = "curname">
               <xpath expression = "data(//a/@href)">
                  <var name = "curnode"/>
               </xpath>
            </var-def>
            
         <script><![CDATA[
                         currentUrl = sys.fullUrl(remotes, curname);                              
                   ]]></script>
         
         <var-def name="tsubnodes">
               <xpath expression="//table//tr[position()>3]">
               <html-to-xml>  
                  <http url="${currentUrl}"/>  
               </html-to-xml>
               </xpath>
            </var-def>
            <loop item = "tcurnode" maxloops ="${tsubnodes.toList().size()-1}">
               <list><var name = "tsubnodes"/></list>
               <body>
                  <var-def name = "tcurname">
                     <xpath expression = "data(//a/@href)">
                        <var name = "tcurnode"/>
                     </xpath>
                  </var-def>
                  <var-def name = "tsize">
                     <xpath expression = "data(//td[4])">
                        <var name = "tcurnode"/>
                     </xpath>
                  </var-def>
                                    
                  <script><![CDATA[
                              tcurrentUrl = sys.fullUrl(currentUrl, tcurname);
                          ]]></script>
                                                    
                  <case>
                     <if condition = '${!tsize.toString().equals("-")}'>
                        <var-def name = "curtime">
                           <xpath expression = "data(//td[3])">
                              <var name = "tcurnode"/>
                           </xpath>
                        </var-def>
                        <!--  
                        <script><![CDATA[                           
                        print(tcurrentUrl);
                        print(tcurname);
                        print(curtime);
                          ]]></script>
                          -->
                      <script><![CDATA[                                              
                        String tnewname = tcurname.toString() + "." + curtime.toString().replace(":","-");
                          ]]></script>                          
                     <file action = "write" path = "${curname}${tnewname}" type = "binary" charset = "UTF-8">
                           <http url = "${tcurrentUrl}" />
                     </file>                          
                     </if>
                     <else>
                        <var-def name = "ssubnodes">
                           <xpath expression="//table//tr[position()>3]">
                              <html-to-xml>
                                 <http url="${tcurrentUrl}"/>
                              </html-to-xml>
                           </xpath>
                        </var-def>
                        <loop item = "ssubnode" maxloops ="${ssubnodes.toList().size()-1}">
                           <list><var name="ssubnodes"/></list>
                           <body>
                              <var-def name="scurname">
                                 <xpath expression="data(//a/@href)">
                                    <var name="ssubnode"/>
                                 </xpath>
                              </var-def>
                              <var-def name = "scurtime">
                                 <xpath expression = "data(//td[3])">
                                    <var name = "ssubnode"/>
                                 </xpath>
                              </var-def>
                              <!--                                
                              <script><![CDATA[
                                 scurrentUrl = sys.fullUrl(tcurrentUrl,scurname);
                                 print(scurrentUrl);
                              print(scurname);
                              print(scurtime);
                              
                                ]]></script>
                                -->
                            <script><![CDATA[
                              String snewname = scurname.toString() + "." + scurtime.toString().replace(":","-");
                                ]]></script>                                
                           <file action = "write" path = "${curname}${tcurname}${snewname}" type = "binary" charset = "UTF-8">
                                 <http url = "${sys.fullUrl(tcurrentUrl,scurname)}" />
                           </file>                                
                           </body>
                        </loop>
                     </else>
                  </case>
               </body>
            </loop>
      </body>
   </loop>
</config>