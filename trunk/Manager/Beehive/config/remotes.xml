<?xml version="1.0" encoding="UTF-8"?>

<config charset="UTF-8">
	<var-def name="remotes">
		http://lirc.sourceforge.net/remotes/
   </var-def>
	<var-def name="subnodes">
		<xpath expression="//table//tr[position()>3]">
			<html-to-xml>
				<http url="${remotes}" />
			</html-to-xml>
		</xpath>
	</var-def>
	<file action="append" path="progress.txt">
		<template>
           <![CDATA[[${sys.datetime("yyyy-MM-dd HH:mm:ss")}]]]>
		</template>
	</file>
	<loop item="curnode" maxloops="${subnodes.toList().size()-1}">
		<list>
			<var name="subnodes" />
		</list>
		<body>
			<var-def name="curname">
				<xpath expression="data(//a/@href)">
					<var name="curnode" />
				</xpath>
			</var-def>

			<script><![CDATA[
                         currentUrl = sys.fullUrl(remotes, curname);                              
                   ]]></script>

			<var-def name="tsubnodes">
				<xpath expression="//table//tr[position()>3]">
					<html-to-xml>
						<http url="${currentUrl}" />
					</html-to-xml>
				</xpath>
			</var-def>
			<loop item="tcurnode" maxloops="${tsubnodes.toList().size()-1}">
				<list>
					<var name="tsubnodes" />
				</list>
				<body>
					<var-def name="tcurname">
						<xpath expression="data(//a/@href)">
							<var name="tcurnode" />
						</xpath>
					</var-def>
					<var-def name="tsize">
						<xpath expression="data(//td[4])">
							<var name="tcurnode" />
						</xpath>
					</var-def>

					<script><![CDATA[
                              tcurrentUrl = sys.fullUrl(currentUrl, tcurname);
                              String tcurnameStr = tcurname.toString();
                              isImage = tcurnameStr.substring(tcurnameStr.lastIndexOf(".") + 1).toLowerCase().matches("gif|png|jpg|bmp");
                          ]]></script>

					<case>
						<if condition='${!tsize.toString().equals("-")}'>
							<var-def name="curtime">
								<xpath expression="data(//td[3])">
									<var name="tcurnode" />
								</xpath>
							</var-def>
							<script><![CDATA[                                           
                        String tnewname = tcurnameStr + "." + curtime.toString().replace(":","-");
                        String path = tcurrentUrl+sys.cr+sys.lf+"["+sys.datetime("yyyy-MM-dd HH:mm:ss")+"]";
                          ]]></script>
                     <case>
                     <if condition="${!isImage}">     
								<file action="write" path="${curname}${tnewname}" type="binary"
									charset="UTF-8">
									<http url="${tcurrentUrl}" />
								</file>
								<file action="append" path="progress.txt">
									<template>
	                           <![CDATA[${path}]]>
									</template>
								</file>
							</if>
							</case>
						</if>
						<else>
							<var-def name="ssubnodes">
								<xpath expression="//table//tr[position()>3]">
									<html-to-xml>
										<http url="${tcurrentUrl}" />
									</html-to-xml>
								</xpath>
							</var-def>
							<loop item="ssubnode" maxloops="${ssubnodes.toList().size()-1}">
								<list>
									<var name="ssubnodes" />
								</list>
								<body>
									<var-def name="scurname">
										<xpath expression="data(//a/@href)">
											<var name="ssubnode" />
										</xpath>
									</var-def>
									<var-def name="scurtime">
										<xpath expression="data(//td[3])">
											<var name="ssubnode" />
										</xpath>
									</var-def>
									<script><![CDATA[
                              scurrentUrl = sys.fullUrl(tcurrentUrl,scurname);
                              String scurnameStr = scurname.toString();
                              isSubImage = scurnameStr.substring(scurnameStr.lastIndexOf(".") + 1).toLowerCase().matches("gif|png|jpg|bmp");
                              String snewname = scurnameStr + "." + scurtime.toString().replace(":","-");
                              String path = scurrentUrl+sys.cr+sys.lf+"["+sys.datetime("yyyy-MM-dd HH:mm:ss")+"]";
                                ]]></script>
                           <case>
                              <if condition="${!isSubImage}">
											<file action="write" path="${curname}${tcurname}${snewname}"
												type="binary" charset="UTF-8">
												<http url="${scurrentUrl}" />
											</file>
											<file action="append" path="progress.txt">
												<template>
		                                  <![CDATA[${path}]]>
												</template>
											</file>
										</if>
									</case>
								</body>
							</loop>
						</else>
					</case>
				</body>
			</loop>
		</body>
	</loop>
	<file action="append" path="progress.txt">
		<template>
         <![CDATA[Download completed!]]>
		</template>
	</file>
</config>